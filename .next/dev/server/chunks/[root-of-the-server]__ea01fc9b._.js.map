{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 42, "column": 0}, "map": {"version":3,"sources":["file:///Users/hung.doan/Documents/GitHubPersonal/nutrition-app/lib/firebaseAdmin.ts"],"sourcesContent":["// lib/firebaseAdmin.ts\nimport { getApps, initializeApp, cert } from \"firebase-admin/app\";\nimport { getAuth } from \"firebase-admin/auth\";\nimport { getFirestore } from \"firebase-admin/firestore\";\n\nif (!getApps().length) {\n  initializeApp({\n    credential: cert({\n      projectId: process.env.FIREBASE_PROJECT_ID,\n      clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\n      privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, \"\\n\"),\n    }),\n  });\n}\n\nexport const adminDb = getFirestore();\n\nexport async function verifyAuth(req: Request) {\n  const authHeader = req.headers.get(\"authorization\");\n  if (!authHeader?.startsWith(\"Bearer \")) return null;\n\n  const token = authHeader.slice(7);\n  try {\n    return await getAuth().verifyIdToken(token);\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA,uBAAuB;AACvB;AACA;AACA;;;;;;;;;;AAEA,IAAI,CAAC,IAAA,mNAAO,IAAG,MAAM,EAAE;IACrB,IAAA,yNAAa,EAAC;QACZ,YAAY,IAAA,gNAAI,EAAC;YACf,WAAW,QAAQ,GAAG,CAAC,mBAAmB;YAC1C,aAAa,QAAQ,GAAG,CAAC,qBAAqB;YAC9C,YAAY,QAAQ,GAAG,CAAC,oBAAoB,EAAE,QAAQ,QAAQ;QAChE;IACF;AACF;AAEO,MAAM,UAAU,IAAA,oOAAY;AAE5B,eAAe,WAAW,GAAY;IAC3C,MAAM,aAAa,IAAI,OAAO,CAAC,GAAG,CAAC;IACnC,IAAI,CAAC,YAAY,WAAW,YAAY,OAAO;IAE/C,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,IAAI;QACF,OAAO,MAAM,IAAA,qNAAO,IAAG,aAAa,CAAC;IACvC,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///Users/hung.doan/Documents/GitHubPersonal/nutrition-app/app/api/foods/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { adminDb, verifyAuth } from \"@/lib/firebaseAdmin\";\n\nexport const runtime = \"nodejs\";\n\nexport async function GET(req: Request) {\n  try {\n    // require authenticated user\n    const user = await verifyAuth(req);\n    if (!user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    const url = new URL(req.url);\n    const group = url.searchParams.get(\"group\");\n    const page = Math.max(1, Number(url.searchParams.get(\"page\") ?? \"1\"));\n    const limit = Math.max(1, Math.min(200, Number(url.searchParams.get(\"limit\") ?? \"50\")));\n\n    // Build Firestore query. Prefer server-side filtered query, but fall back\n    // to an in-memory filter if Firestore requires a composite index (helps\n    // development when indexes aren't yet deployed).\n    let foods: any[] = [];\n\n    try {\n      let query: FirebaseFirestore.Query = adminDb.collection(\"foods\");\n      if (group) query = query.where(\"group\", \"==\", group);\n\n      // order by name for stable pagination\n      query = query.orderBy(\"name\").limit(limit).offset((page - 1) * limit);\n\n      const snapshot = await query.get();\n\n      snapshot.forEach((doc) => {\n        const data = doc.data();\n        foods.push({\n          id: doc.id,\n          term: data.term ?? null,\n          name: data.name ?? data.description ?? null,\n          group: data.group ?? null,\n          nutrients: data.nutrients ?? {},\n          defaultPortionGrams: data.defaultPortionGrams ?? data.measurement ?? null,\n        });\n      });\n    } catch (err: any) {\n      // If Firestore complains about a missing index, fall back to a full\n      // collection scan and do filtering + pagination in-memory. This is\n      // less efficient but avoids a hard failure while developing.\n      const msg = String(err?.message ?? err);\n      if (msg.includes(\"requires an index\") || msg.includes(\"FAILED_PRECONDITION\")) {\n        const snapshotAll = await adminDb.collection(\"foods\").get();\n        const all: any[] = [];\n        snapshotAll.forEach((doc) => {\n          const data = doc.data();\n          all.push({\n            id: doc.id,\n            term: data.term ?? null,\n            name: data.name ?? data.description ?? null,\n            group: data.group ?? null,\n            nutrients: data.nutrients ?? {},\n            defaultPortionGrams: data.defaultPortionGrams ?? data.measurement ?? null,\n          });\n        });\n\n        // filter by group if requested\n        const filtered = group ? all.filter((f) => f.group === group) : all;\n\n        // sort by name for stable pagination\n        filtered.sort((a, b) => (a.name ?? \"\").localeCompare(b.name ?? \"\"));\n\n        const start = (page - 1) * limit;\n        foods = filtered.slice(start, start + limit);\n      } else {\n        throw err;\n      }\n    }\n\n    return NextResponse.json({ page, limit, count: foods.length, foods });\n  } catch (err: any) {\n    return NextResponse.json({ error: \"Failed to fetch foods\", detail: err?.message ?? String(err) }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;AAEO,MAAM,UAAU;AAEhB,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,6BAA6B;QAC7B,MAAM,OAAO,MAAM,IAAA,oIAAU,EAAC;QAC9B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QACA,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;QAC3B,MAAM,QAAQ,IAAI,YAAY,CAAC,GAAG,CAAC;QACnC,MAAM,OAAO,KAAK,GAAG,CAAC,GAAG,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,WAAW;QAChE,MAAM,QAAQ,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,KAAK,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;QAEhF,0EAA0E;QAC1E,wEAAwE;QACxE,iDAAiD;QACjD,IAAI,QAAe,EAAE;QAErB,IAAI;YACF,IAAI,QAAiC,iIAAO,CAAC,UAAU,CAAC;YACxD,IAAI,OAAO,QAAQ,MAAM,KAAK,CAAC,SAAS,MAAM;YAE9C,sCAAsC;YACtC,QAAQ,MAAM,OAAO,CAAC,QAAQ,KAAK,CAAC,OAAO,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI;YAE/D,MAAM,WAAW,MAAM,MAAM,GAAG;YAEhC,SAAS,OAAO,CAAC,CAAC;gBAChB,MAAM,OAAO,IAAI,IAAI;gBACrB,MAAM,IAAI,CAAC;oBACT,IAAI,IAAI,EAAE;oBACV,MAAM,KAAK,IAAI,IAAI;oBACnB,MAAM,KAAK,IAAI,IAAI,KAAK,WAAW,IAAI;oBACvC,OAAO,KAAK,KAAK,IAAI;oBACrB,WAAW,KAAK,SAAS,IAAI,CAAC;oBAC9B,qBAAqB,KAAK,mBAAmB,IAAI,KAAK,WAAW,IAAI;gBACvE;YACF;QACF,EAAE,OAAO,KAAU;YACjB,oEAAoE;YACpE,mEAAmE;YACnE,6DAA6D;YAC7D,MAAM,MAAM,OAAO,KAAK,WAAW;YACnC,IAAI,IAAI,QAAQ,CAAC,wBAAwB,IAAI,QAAQ,CAAC,wBAAwB;gBAC5E,MAAM,cAAc,MAAM,iIAAO,CAAC,UAAU,CAAC,SAAS,GAAG;gBACzD,MAAM,MAAa,EAAE;gBACrB,YAAY,OAAO,CAAC,CAAC;oBACnB,MAAM,OAAO,IAAI,IAAI;oBACrB,IAAI,IAAI,CAAC;wBACP,IAAI,IAAI,EAAE;wBACV,MAAM,KAAK,IAAI,IAAI;wBACnB,MAAM,KAAK,IAAI,IAAI,KAAK,WAAW,IAAI;wBACvC,OAAO,KAAK,KAAK,IAAI;wBACrB,WAAW,KAAK,SAAS,IAAI,CAAC;wBAC9B,qBAAqB,KAAK,mBAAmB,IAAI,KAAK,WAAW,IAAI;oBACvE;gBACF;gBAEA,+BAA+B;gBAC/B,MAAM,WAAW,QAAQ,IAAI,MAAM,CAAC,CAAC,IAAM,EAAE,KAAK,KAAK,SAAS;gBAEhE,qCAAqC;gBACrC,SAAS,IAAI,CAAC,CAAC,GAAG,IAAM,CAAC,EAAE,IAAI,IAAI,EAAE,EAAE,aAAa,CAAC,EAAE,IAAI,IAAI;gBAE/D,MAAM,QAAQ,CAAC,OAAO,CAAC,IAAI;gBAC3B,QAAQ,SAAS,KAAK,CAAC,OAAO,QAAQ;YACxC,OAAO;gBACL,MAAM;YACR;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;YAAM;YAAO,OAAO,MAAM,MAAM;YAAE;QAAM;IACrE,EAAE,OAAO,KAAU;QACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAAyB,QAAQ,KAAK,WAAW,OAAO;QAAK,GAAG;YAAE,QAAQ;QAAI;IAClH;AACF"}}]
}