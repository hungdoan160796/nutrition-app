{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 42, "column": 0}, "map": {"version":3,"sources":["file:///Users/hung.doan/Documents/GitHubPersonal/nutrition-app/app/api/foods/add/route.ts"],"sourcesContent":["export const runtime = 'nodejs';\n\nimport { NextResponse } from 'next/server';\nimport OpenAI from 'openai';\nimport { initializeApp, cert, getApps } from 'firebase-admin/app';\nimport { getFirestore } from 'firebase-admin/firestore';\n\nconst FOOD_GROUPS = [\n  'starch',\n  'meat',\n  'fish',\n  'seafood',\n  'vegetables',\n  'legumes',\n  'fruits',\n  'drinks',\n  'condiments',\n  'seasonings'\n] as const;\n\ntype FoodGroup = (typeof FOOD_GROUPS)[number];\n\ntype Nutrients = {\n  vitamin_a: number;\n  fat: number;\n  carbohydrate: number;\n  calories: number;\n  calcium: number;\n  potassium: number;\n  zinc: number;\n  protein: number;\n  iron: number;\n  magnesium: number;\n  sodium: number;\n  vitamin_c: number;\n  folate: number;\n  vitamin_b12: number;\n  vitamin_d: number;\n};\n\nconst EMPTY_NUTRIENTS: Nutrients = {\n  vitamin_a: 0,\n  fat: 0,\n  carbohydrate: 0,\n  calories: 0,\n  calcium: 0,\n  potassium: 0,\n  zinc: 0,\n  protein: 0,\n  iron: 0,\n  magnesium: 0,\n  sodium: 0,\n  vitamin_c: 0,\n  folate: 0,\n  vitamin_b12: 0,\n  vitamin_d: 0,\n};\n\n/* ---------------- FIREBASE INIT ---------------- */\n\nif (!getApps().length) {\n  initializeApp({\n    credential: cert({\n      projectId: process.env.FIREBASE_PROJECT_ID,\n      clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\n      privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n'),\n    }),\n  });\n}\n\nconst db = getFirestore();\n\n/* ---------------- ROUTE ---------------- */\n\nexport async function POST(req: Request) {\n  try {\n    const openaiKey =\n      req.headers.get('x-openai-key') ??\n      process.env.NEXT_PUBLIC_OPENAI_API_KEY;\n\n    if (!openaiKey) {\n      return NextResponse.json(\n        { error: 'Missing OpenAI key' },\n        { status: 401 }\n      );\n    }\n\n    const contentType = req.headers.get('content-type') ?? '';\n    if (!contentType.toLowerCase().includes('application/json')) {\n      return NextResponse.json(\n        { error: 'Invalid Content-Type: expected application/json' },\n        { status: 400 }\n      );\n    }\n\n    let body: any;\n    try {\n      body = await req.json();\n    } catch (parseErr: any) {\n      return NextResponse.json(\n        {\n          error: 'Invalid JSON body',\n          detail: parseErr?.message ?? String(parseErr),\n        },\n        { status: 400 }\n      );\n    }\n\n    let { food, term, fdcId } = body ?? {};\n\n    if (!food && fdcId) {\n      const usdaKey = process.env.USDA_API_KEY;\n      if (!usdaKey) {\n        return NextResponse.json(\n          { error: 'USDA API key missing' },\n          { status: 500 }\n        );\n      }\n\n      const res = await fetch(\n        `https://api.nal.usda.gov/fdc/v1/food/${encodeURIComponent(\n          String(fdcId)\n        )}?api_key=${usdaKey}`\n      );\n\n      if (!res.ok) {\n        return NextResponse.json(\n          { error: 'Failed to fetch USDA food details' },\n          { status: 500 }\n        );\n      }\n\n      try {\n        food = await res.json();\n      } catch {\n        return NextResponse.json(\n          { error: 'Invalid USDA response' },\n          { status: 500 }\n        );\n      }\n    }\n\n    const missing: string[] = [];\n    if (!food) missing.push('food');\n    else {\n      if (!food.fdcId) missing.push('food.fdcId');\n      if (!food.description) missing.push('food.description');\n    }\n\n    if (missing.length) {\n      return NextResponse.json(\n        { error: 'Invalid payload', missing },\n        { status: 400 }\n      );\n    }\n\n    const openai = new OpenAI({ apiKey: openaiKey });\n\n    let nutrientsSource: any[] = [];\n    if (Array.isArray(food.foodNutrients)) {\n      nutrientsSource = food.foodNutrients;\n    } else if (food.labelNutrients && typeof food.labelNutrients === 'object') {\n      nutrientsSource = Object.entries(food.labelNutrients).map(\n        ([k, v]: any) => ({\n          nutrient: { name: k },\n          amount: v?.value ?? v,\n        })\n      );\n    } else if (food.foodNutrient && typeof food.foodNutrient === 'object') {\n      nutrientsSource = [food.foodNutrient];\n    }\n\n    const [group, nutrients] = await Promise.all([\n      classifyFoodGroup(openai, food.description),\n      normalizeNutrients(openai, nutrientsSource),\n    ]);\n\n    const entry = {\n      fdcId: food.fdcId,\n      description: food.description,\n      brandName: food.brandOwner ?? food.brandName ?? null,\n      foodNutrients: nutrients,\n      servingSize: Number(food.servingSize),\n      servingSizeUnit: food.servingSizeUnit,\n      group,\n      term: term ?? null,\n      createdAt: new Date(),\n    };\n\n    await db\n      .collection('foods')\n      .doc(String(food.fdcId))\n      .set(entry, { merge: true });\n\n    return NextResponse.json({\n      success: true,\n      id: String(food.fdcId),\n    });\n  } catch (err: any) {\n    return NextResponse.json(\n      {\n        error: 'Failed to add food',\n        detail: err?.message ?? 'Unknown error',\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/* ---------------- HELPERS ---------------- */\n\nasync function classifyFoodGroup(\n  openai: OpenAI,\n  name: string\n): Promise<FoodGroup> {\n  try {\n    const res = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      temperature: 0,\n      messages: [\n        { role: 'system', content: 'Return ONE category only.' },\n        {\n          role: 'user',\n          content: `Food: \"${name}\"\nCategories: ${FOOD_GROUPS.join(', ')}`,\n        },\n      ],\n    });\n\n    const value =\n      res.choices[0]?.message?.content?.trim().toLowerCase() ?? '';\n\n    return FOOD_GROUPS.includes(value as FoodGroup)\n      ? (value as FoodGroup)\n      : 'seasonings';\n  } catch {\n    return 'seasonings';\n  }\n}\n\nasync function normalizeNutrients(\n  openai: OpenAI,\n  foodNutrients: any[]\n): Promise<Nutrients> {\n  try {\n    const res = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      temperature: 0,\n      messages: [\n        {\n          role: 'system',\n          content: `\nYou are a nutrition data normalizer.\n\nMap USDA nutrient entries into the EXACT JSON schema below.\nReturn ONLY valid JSON.\n\nSchema:\n{\n  \"vitamin_a\": number,\n  \"fat\": number,\n  \"carbohydrate\": number,\n  \"calories\": number,\n  \"calcium\": number,\n  \"potassium\": number,\n  \"zinc\": number,\n  \"protein\": number,\n  \"iron\": number,\n  \"magnesium\": number,\n  \"sodium\": number,\n  \"vitamin_c\": number,\n  \"folate\": number,\n  \"vitamin_b12\": number,\n  \"vitamin_d\": number\n}\n\nRules:\n- Use closest USDA nutrient names\n- Convert units if needed\n- Missing values must be 0\n- No extra keys\n          `.trim(),\n        },\n        { role: 'user', content: JSON.stringify(foodNutrients) },\n      ],\n    });\n\n    const raw = res.choices[0]?.message?.content;\n    if (!raw) return EMPTY_NUTRIENTS;\n\n    const parsed = JSON.parse(raw);\n\n    return {\n      vitamin_a: Number(parsed.vitamin_a) || 0,\n      fat: Number(parsed.fat) || 0,\n      carbohydrate: Number(parsed.carbohydrate) || 0,\n      calories: Number(parsed.calories) || 0,\n      calcium: Number(parsed.calcium) || 0,\n      potassium: Number(parsed.potassium) || 0,\n      zinc: Number(parsed.zinc) || 0,\n      protein: Number(parsed.protein) || 0,\n      iron: Number(parsed.iron) || 0,\n      magnesium: Number(parsed.magnesium) || 0,\n      sodium: Number(parsed.sodium) || 0,\n      vitamin_c: Number(parsed.vitamin_c) || 0,\n      folate: Number(parsed.folate) || 0,\n      vitamin_b12: Number(parsed.vitamin_b12) || 0,\n      vitamin_d: Number(parsed.vitamin_d) || 0,\n    };\n  } catch {\n    return EMPTY_NUTRIENTS;\n  }\n}\n"],"names":[],"mappings":"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"}}]
}